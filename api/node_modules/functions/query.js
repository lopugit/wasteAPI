
let query = async function (req, res, client) {
  console.log("Querying the database with the following keyword(s): " + req.body.message);

  // connect to mongodb connection

  let db = client.db("wastee");
  let items = db.collection("items");

  // query: 
  let query_output = await items.aggregate([
    {
      $search: {
        "text": {
          "query": req.body.message,
          "path": "name"
        }
      }
    },
    {
      $limit: 5 // max number of items returned 
    },
    {
      // return the advice and if it is recyclable
      $project: {
        "_id": 0,
        "name": 1,
        "recyclable": 1,
        "advice": 1
      }
    }
  ]).toArray()

  console.log(JSON.stringify(query_output[0]))

  let output_message = "";

  for (var i = 0; i < query_output.length; i++) {
    console.log(JSON.stringify(query_output[i]))
    output_message = output_message + "Item: " + query_output[i].name +
      ". Recyclable: " + query_output[i].recyclable +
      ". Advice: " + query_output[i].advice
    output_message = output_message + "\n"
  }

  res.status(200).send({
    info: output_message
  })
}

module.exports = query