
let query = async function (req, res) {
  console.log("Querying the database with the following keyword(s): " + req.body.message);

  // connect to mongodb connection

  let db = global.client.db("wastee");
  let items = db.collection("items");

  let query = {
    $search: {
      "text": {
        "query": req.body.message,
        "path": "name",
        "fuzzy": { // enables fuzzy
          "maxEdits": 2,
          "prefixLength": 2,
          "maxExpansions": 100
        }
      }
    }
  }

  // query: 
  let query_output = await items.aggregate([
    query,
    {
      $limit: 5 // max number of items returned 
    },
    {
      // return the advice and if it is recyclable
      $project: {
        "_id": 0,
        "name": 1,
        "category": 1,
        "recyclable": 1,
        "advice": 1
      }
    }
  ]).toArray()

  let output_message = "Sorry! We didn't find any recycling information for the description you gave!"

  if (query_output.length > 0) {
    output_message = ""

    for (var i = 0; i < query_output.length; i++) {
      output_message += "You asked about " + query_output[i].name + ", which is in the category " + query_output[i].category + ".\n\n" +
        "Is it recyclable? " + query_output[i].recyclable + ".\n\n" +
        query_output[i].advice + "\n\n"
    }

  }

  return output_message

}

module.exports = query