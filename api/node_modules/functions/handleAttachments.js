let smarts = require('smarts')()
let fs = require('fs')
let FileType = require('file-type')
let uuid = require('uuid').v4

let handleAttachments = async function(req, res){
	// Save attachments to request ID based local directory database
	await asyncForEach(req.body.attachments, async attachment=>{
		if(attachment.type == 'image'){
			if(!(smarts.getsmart(attachment, 'imageData.bin', undefined) instanceof Buffer)){
				attachment.imageData.bin = new Buffer.from(attachment.imageData.bin.data)
			}
			let url = attachment.payload.url
			let dir = __dirname+"/../../../imageDB/"+req.uuid+"/"

			// create directory for sender
			if (!fs.existsSync(dir)){
				fs.mkdirSync(dir)
			}

			// add filename uuid to attachment object
			attachment.uuid = uuid()

			// create path out of local directory + sender facebook ID
			path = dir+attachment.uuid
			
			// download image to sender ID'd local folder DB
			attachment.imageData = await save(attachment.imageData, path)

		}
	})

}

module.exports = handleAttachments

async function save(data, path){
	try {
		data.ext = (await FileType.fromBuffer(data.bin) || { ext: 'unknown' }).ext
		fs.writeFileSync(path+"."+data.ext, data.bin)
	} catch(err){
		console.error("Something went wrong saveing the file from data")
		console.error(err)
	}
}


async function asyncForEach(array, callback) {
  for (let index = 0; index < array.length; index++) {
    await callback(array[index], index, array);
  }
}