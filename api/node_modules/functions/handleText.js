
let query = async function (req, res) {
  console.log("Querying the database with the following keyword(s): " + req.body.message);

  // connect to mongodb connection

  let db = global.client.db("wastee");
  let items = db.collection("items");

	let allWords = req.body.message.split(" ")

  // query: 
  let query_output = []
	if(req.body.message){

		query_output = await items.aggregate([
			{
				$search: {
					"compound": {
						"should": [
							{
								"text": {
									"query": req.body.message,
									"path": "name",
									"fuzzy": {
										"maxEdits": 2,
										"maxExpansions": 500
									}
								}
							},
							{
								"text": {
									"query": req.body.message,
									"path": {
										value: "name",
										"multi": "standardAnalyzer"
									},
									"fuzzy": {
										"maxEdits": 2,
										"maxExpansions": 500
									}
								}
							},
							{
								"text": {
									"query": req.body.message,
									"path": "category",
									"fuzzy": {
										"maxEdits": 2,
										"maxExpansions": 500
									}
								}
							},
							{
								"text": {
									"query": req.body.message,
									"path": {
										value: "category",
										"multi": "standardAnalyzer"
									},
									"fuzzy": {
										"maxEdits": 2,
										"maxExpansions": 500
									}
								}
							},
						]
					}
				}
			},
			{
				$limit: 4 // max number of items returned 
			},
			{
				// return the advice and if it is recyclable
				$project: {
					"_id": 0,
					"name": 1,
					"category": 1,
					"recyclable": 1,
					"advice": 1,
					"score": { "$meta": "searchScore" }
				}
			}
		]).toArray()

	}

	res.response.query_output = query_output


	let output_message = "Sorry! We didn't find any recycling information for the description you gave!"
	
	if(typeof res.response.imageDescription == 'string'){
		output_message = "Sorry! We didn't find any recycling information for the image you gave!"
	}
	
  if(query_output.length > 0){

		output_message = ""

		if(res.response.imageDescription) {
			output_message += "We analyzed your picture and came up with the following description: " + res.response.imageDescription + "\n\n" 
		}
		
		
		for (var i = 0; i < query_output.length; i++) {
			output_message += "If you're asking about " + query_output[i].name + ", which is in the category " + query_output[i].category +", this is what we found: \n\n" +
				"Is it recyclable? " + query_output[i].recyclable + "."
				if(query_output[i].advice) output_message += "\n\n" + query_output[i].advice
				output_message += "\n\n"
		}

  }

	res.response.info = output_message

}

module.exports = query